(ns frankentone.genetic.mfcc-test
  (:use clojure.test
        [frankentone.genetic analysis mfcc]
        [frankentone samples utils])
  (:require clojure.java.io))

(def samp (load-sample (clojure.java.io/resource "hihat-open.wav")))


;; scmir  42 mfccs unnormalized
;; e = SCMIRAudioFile ("/Users/hb/src/frankentone/hihat-open.wav", [[MFCC, 42]])
;; e.extractFeatures(false)
;; e.featuredata.clump(42).postcs

(def reference-mfcc [ [ -0.73077589273453, 0.49476635456085, 0.18339559435844, 0.25331175327301, 0.16232344508171, 0.24991053342819, 0.27141547203064, 0.20933969318867, 0.25124090909958, 0.17718574404716, 0.21416153013706, 0.20023387670517, 0.24918441474438, 0.2352661639452, 0.22761572897434, 0.21348410844803, 0.32958996295929, 0.35701495409012, 0.31626343727112, 0.27038657665253, 0.25402528047562, 0.22446365654469, 0.19613754749298, 0.27042579650879, 0.29238080978394, 0.26444247364998, 0.23151542246342, 0.23273299634457, 0.2477123439312, 0.25547966361046, 0.25888657569885, 0.23347461223602, 0.22309112548828, 0.28006920218468, 0.25519925355911, 0.17398029565811, 0.20797675848007, 0.24887502193451, 0.22015203535557, 0.23833304643631, 0.29474171996117, 0.25 ], [ -0.73071402311325, 0.40040516853333, 0.17405551671982, 0.21073725819588, 0.18363988399506, 0.24659597873688, 0.26598426699638, 0.16409140825272, 0.22165638208389, 0.23280090093613, 0.28638938069344, 0.25996163487434, 0.24716317653656, 0.28342092037201, 0.27558219432831, 0.24640126526356, 0.26056811213493, 0.26008826494217, 0.25917705893517, 0.24254260957241, 0.27434074878693, 0.2434478700161, 0.14138349890709, 0.21119010448456, 0.27578455209732, 0.22657968103886, 0.25878325104713, 0.24347375333309, 0.21926119923592, 0.2025201767683, 0.25789853930473, 0.26768133044243, 0.25677970051765, 0.27696907520294, 0.24868434667587, 0.20917046070099, 0.22521585226059, 0.24842244386673, 0.20478703081608, 0.2430957108736, 0.27044072747231, 0.25 ], [ -0.78947961330414, 0.35688284039497, 0.20597149431705, 0.2399932295084, 0.16262772679329, 0.17585085332394, 0.21861676871777, 0.18752205371857, 0.18671070039272, 0.1917809844017, 0.25873309373856, 0.22267925739288, 0.27728521823883, 0.39941155910492, 0.32773807644844, 0.20705951750278, 0.28752985596657, 0.29533249139786, 0.31658735871315, 0.28172093629837, 0.28966265916824, 0.25220081210136, 0.19907402992249, 0.26896068453789, 0.31921920180321, 0.31778874993324, 0.29289409518242, 0.25494733452797, 0.21181917190552, 0.18458142876625, 0.26119244098663, 0.27516913414001, 0.25120091438293, 0.2405718266964, 0.21853759884834, 0.21342028677464, 0.22694925963879, 0.26537349820137, 0.22955340147018, 0.24688397347927, 0.26917338371277, 0.25 ], [ -0.73170506954193, 0.28184905648232, 0.18639755249023, 0.29107555747032, 0.20930264890194, 0.19103762507439, 0.32349282503128, 0.2831646502018, 0.30256989598274, 0.18682739138603, 0.21629449725151, 0.2292073816061, 0.27786189317703, 0.26296609640121, 0.22295360267162, 0.22222875058651, 0.30104410648346, 0.32550099492073, 0.29243233799934, 0.25682216882706, 0.31008446216583, 0.26784417033195, 0.16229009628296, 0.25433203577995, 0.33086091279984, 0.26318123936653, 0.23521083593369, 0.24197256565094, 0.19480049610138, 0.16535194218159, 0.22872072458267, 0.27788493037224, 0.27599304914474, 0.28098878264427, 0.20993477106094, 0.20269058644772, 0.25018069148064, 0.25585666298866, 0.24767206609249, 0.24196350574493, 0.29837667942047, 0.25 ], [ -0.7274517416954, 0.27043095231056, 0.18499054014683, 0.30719476938248, 0.18740051984787, 0.16823698580265, 0.31522619724274, 0.25205311179161, 0.23447023332119, 0.22113139927387, 0.27842101454735, 0.31143641471863, 0.33882600069046, 0.25081884860992, 0.26385083794594, 0.23200009763241, 0.29318889975548, 0.31653845310211, 0.23807182908058, 0.18298101425171, 0.2523612678051, 0.2275967746973, 0.16670455038548, 0.29274463653564, 0.34289857745171, 0.30918005108833, 0.27453252673149, 0.29776552319527, 0.27997803688049, 0.21531276404858, 0.25764387845993, 0.26609316468239, 0.256526440382, 0.26639842987061, 0.21162496507168, 0.1842043697834, 0.21295762062073, 0.23534645140171, 0.23753514885902, 0.242252856493, 0.28549915552139, 0.25 ], [ -0.69986003637314, 0.38977378606796, 0.22208005189896, 0.21733923256397, 0.18706150352955, 0.15471282601357, 0.20160272717476, 0.14281116425991, 0.18907427787781, 0.15392300486565, 0.28903663158417, 0.26990315318108, 0.27173793315887, 0.2859970331192, 0.30444478988647, 0.26772305369377, 0.30280563235283, 0.2925027012825, 0.26905816793442, 0.23101378977299, 0.21796134114265, 0.23931139707565, 0.17843692004681, 0.27460309863091, 0.27263805270195, 0.28084450960159, 0.25143754482269, 0.21164160966873, 0.27218356728554, 0.19182635843754, 0.21708631515503, 0.25311377644539, 0.23180918395519, 0.23793460428715, 0.24733243882656, 0.2296973913908, 0.2217230796814, 0.28007590770721, 0.2184706479311, 0.24981708824635, 0.25710946321487, 0.25 ], [ -0.7387969493866, 0.40712949633598, 0.28860095143318, 0.35160738229752, 0.27022576332092, 0.2116319835186, 0.14858067035675, 0.14524829387665, 0.24697004258633, 0.19036522507668, 0.27880308032036, 0.30249723792076, 0.28909948468208, 0.2753694653511, 0.27785623073578, 0.32972157001495, 0.2778816819191, 0.24650967121124, 0.22520059347153, 0.18994732201099, 0.23554262518883, 0.25278955698013, 0.18188932538033, 0.26296347379684, 0.28444641828537, 0.26769736409187, 0.25035512447357, 0.26486086845398, 0.23890393972397, 0.20602925121784, 0.21746437251568, 0.2448804974556, 0.23549367487431, 0.26739829778671, 0.25881132483482, 0.19104298949242, 0.24644741415977, 0.2553962469101, 0.22904726862907, 0.26549750566483, 0.29355704784393, 0.25 ], [ -0.69601047039032, 0.38374823331833, 0.21056915819645, 0.26967346668243, 0.26948019862175, 0.22140768170357, 0.22581762075424, 0.18764550983906, 0.19590049982071, 0.20656698942184, 0.22906504571438, 0.25831252336502, 0.32295650243759, 0.27936971187592, 0.31119042634964, 0.307821393013, 0.28245493769646, 0.28304719924927, 0.26444581151009, 0.21531531214714, 0.24905283749104, 0.24751089513302, 0.18959890305996, 0.266941010952, 0.31266984343529, 0.29749548435211, 0.28666615486145, 0.29370963573456, 0.25333654880524, 0.17152586579323, 0.25617814064026, 0.23147696256638, 0.2255844026804, 0.25986656546593, 0.23092104494572, 0.23967695236206, 0.24951024353504, 0.23582810163498, 0.22173774242401, 0.24690747261047, 0.27134647965431, 0.25 ], [ -0.62753766775131, 0.42876935005188, 0.21567833423615, 0.24870163202286, 0.20894005894661, 0.28857371211052, 0.28264763951302, 0.21489815413952, 0.29136836528778, 0.18733368813992, 0.24490429461002, 0.22955375909805, 0.26517453789711, 0.25588420033455, 0.31420037150383, 0.29519873857498, 0.27872145175934, 0.29610031843185, 0.25987872481346, 0.17071932554245, 0.22610227763653, 0.22910736501217, 0.1830580830574, 0.25808358192444, 0.31792014837265, 0.31227082014084, 0.28967744112015, 0.2970264852047, 0.26534879207611, 0.21286933124065, 0.21023182570934, 0.26869356632233, 0.27702349424362, 0.27933463454247, 0.24842147529125, 0.22414082288742, 0.2746390402317, 0.25772351026535, 0.2249473631382, 0.25303190946579, 0.27409321069717, 0.25 ], [ -0.68083143234253, 0.31041243672371, 0.23063088953495, 0.34613579511642, 0.26395633816719, 0.25600868463516, 0.19986459612846, 0.093646690249443, 0.2408135086298, 0.25738555192947, 0.33749461174011, 0.3375286757946, 0.31800618767738, 0.2624049782753, 0.32324108481407, 0.26806390285492, 0.24307654798031, 0.29939714074135, 0.22488343715668, 0.24639657139778, 0.31769722700119, 0.25015208125114, 0.19824093580246, 0.26871147751808, 0.34602883458138, 0.24516515433788, 0.25795948505402, 0.27573508024216, 0.24006679654121, 0.19284644722939, 0.24314254522324, 0.28195574879646, 0.25424551963806, 0.26071441173553, 0.27858909964561, 0.26562422513962, 0.25654429197311, 0.24589872360229, 0.24603267014027, 0.22757172584534, 0.24222750961781, 0.25 ], [ -0.6142520904541, 0.39057892560959, 0.20711381733418, 0.30981066823006, 0.23307451605797, 0.27207246422768, 0.25686112046242, 0.19328260421753, 0.23909376561642, 0.18780595064163, 0.24853295087814, 0.3081379532814, 0.3526309132576, 0.23767550289631, 0.25055766105652, 0.26738250255585, 0.29794031381607, 0.2841437458992, 0.25824216008186, 0.24572239816189, 0.28884601593018, 0.26629945635796, 0.20251908898354, 0.27502471208572, 0.36436632275581, 0.31006067991257, 0.26531699299812, 0.23725508153439, 0.24168761074543, 0.19061452150345, 0.23019441962242, 0.28162258863449, 0.28323957324028, 0.28980168700218, 0.2561414539814, 0.23519343137741, 0.27404460310936, 0.2486956268549, 0.23966020345688, 0.25079223513603, 0.26467904448509, 0.25 ], [ -0.73891162872314, 0.4156522154808, 0.24087479710579, 0.25042104721069, 0.25937923789024, 0.29813912510872, 0.25901424884796, 0.27513608336449, 0.305988073349, 0.19173128902912, 0.21368533372879, 0.19840639829636, 0.27200016379356, 0.28161877393723, 0.30636945366859, 0.2954540848732, 0.30496513843536, 0.26351115107536, 0.23550945520401, 0.23899529874325, 0.29813686013222, 0.22085066139698, 0.17885835468769, 0.25454235076904, 0.32595854997635, 0.30100977420807, 0.31560575962067, 0.27583384513855, 0.2594241797924, 0.19868519902229, 0.23776745796204, 0.26198735833168, 0.23677432537079, 0.24535991251469, 0.23114208877087, 0.21020710468292, 0.22804461419582, 0.25302493572235, 0.22732809185982, 0.25564512610435, 0.2621163725853, 0.25 ], [ -0.66543114185333, 0.47013482451439, 0.32376545667648, 0.37130334973335, 0.25450032949448, 0.27201893925667, 0.3136214017868, 0.21143685281277, 0.26174178719521, 0.11543688178062, 0.25765639543533, 0.2412520647049, 0.26713263988495, 0.22786144912243, 0.27703621983528, 0.27393019199371, 0.29385280609131, 0.2667661011219, 0.25824272632599, 0.26702171564102, 0.34090331196785, 0.25256186723709, 0.15503549575806, 0.23491178452969, 0.34298402070999, 0.28855794668198, 0.22101452946663, 0.24905037879944, 0.31685256958008, 0.2515509724617, 0.21262501180172, 0.21677674353123, 0.23952169716358, 0.27398386597633, 0.2228587269783, 0.21961621940136, 0.24750626087189, 0.29427194595337, 0.26784473657608, 0.23180976510048, 0.25714161992073, 0.25 ], [ -0.56469768285751, 0.54319322109222, 0.32406735420227, 0.32503926753998, 0.2962594628334, 0.28416982293129, 0.23398490250111, 0.12600362300873, 0.19088074564934, 0.15542271733284, 0.28322684764862, 0.30899801850319, 0.33476084470749, 0.31879958510399, 0.31636548042297, 0.32532995939255, 0.30514016747475, 0.23765289783478, 0.23124417662621, 0.21309494972229, 0.24306818842888, 0.24521668255329, 0.22404517233372, 0.27006381750107, 0.31167775392532, 0.31649005413055, 0.27236199378967, 0.27732545137405, 0.27482038736343, 0.21896870434284, 0.24131755530834, 0.22953337430954, 0.22374707460403, 0.26347741484642, 0.24533013999462, 0.25459063053131, 0.23910209536552, 0.22393338382244, 0.21365177631378, 0.22453999519348, 0.26985934376717, 0.25 ], [ -0.53551131486893, 0.50938498973846, 0.27928623557091, 0.32505384087563, 0.23796850442886, 0.29797887802124, 0.21262884140015, 0.11371889710426, 0.25818881392479, 0.24722281098366, 0.32064259052277, 0.24700656533241, 0.31840470433235, 0.31310334801674, 0.345139503479, 0.22852766513824, 0.21770147979259, 0.27919739484787, 0.21655069291592, 0.21443927288055, 0.28109133243561, 0.24087615311146, 0.2055761218071, 0.25802168250084, 0.29703012108803, 0.2836112678051, 0.28094151616096, 0.32392823696136, 0.28874763846397, 0.2305323779583, 0.23175466060638, 0.26441353559494, 0.27736362814903, 0.2790752351284, 0.269415974617, 0.24370791018009, 0.23538601398468, 0.27059409022331, 0.23155342042446, 0.26508006453514, 0.28790858387947, 0.25 ], [ -0.51642453670502, 0.48780560493469, 0.26285421848297, 0.26837736368179, 0.26790517568588, 0.28485763072968, 0.27852758765221, 0.19025246798992, 0.29084631800652, 0.2372290790081, 0.33753335475922, 0.25644305348396, 0.30615627765656, 0.32712569832802, 0.35868215560913, 0.29261335730553, 0.29235327243805, 0.24884669482708, 0.23318721354008, 0.25221925973892, 0.33976620435715, 0.25839865207672, 0.19914938509464, 0.30911752581596, 0.29197210073471, 0.28507754206657, 0.25043180584908, 0.25260752439499, 0.25294935703278, 0.21958363056183, 0.24027301371098, 0.23369671404362, 0.24826939404011, 0.28680917620659, 0.234245210886, 0.23789824545383, 0.26343861222267, 0.27528944611549, 0.23293881118298, 0.24140766263008, 0.27452638745308, 0.25 ], [ -0.41049712896347, 0.46042656898499, 0.33223158121109, 0.31914103031158, 0.31908643245697, 0.25035205483437, 0.2676762342453, 0.18674951791763, 0.23978705704212, 0.28219628334045, 0.31935077905655, 0.29844826459885, 0.36266124248505, 0.32139313220978, 0.25141307711601, 0.26651763916016, 0.29555171728134, 0.22961029410362, 0.1945816129446, 0.1969131231308, 0.30592042207718, 0.24921256303787, 0.1795955747366, 0.26355251669884, 0.26063978672028, 0.26464623212814, 0.2514456808567, 0.32422986626625, 0.30182835459709, 0.24526469409466, 0.26848092675209, 0.2422194480896, 0.22321355342865, 0.24888116121292, 0.24703611433506, 0.22898298501968, 0.20428562164307, 0.23932954668999, 0.26022925972939, 0.2449656277895, 0.26490947604179, 0.25 ] ])


(deftest mfcc-test
  (let [mfccs (mfcc (take 17 (take-nth 2 (get-fft-mags samp))) 42)]
    (dotimes [i 17]
      (is (< (reduce + (map #(Math/abs (- ^float %2 ^float %1))
                            (nth mfccs i)
                            (nth reference-mfcc i)))
             0.003)))))
